name: CI/CD Workflow

on:
  push:
    branches:
      - main

jobs:
  # ì‘ì—…2: GCP ë°°í¬
  deploy:
    runs-on: ubuntu-latest
    env:
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      PORT: ${{ secrets.PORT }}
      NODE_ENV: ${{ secrets.NODE_ENV }}
    steps:
      # GCP ì¸ì¦
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v0.6.0
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

    # GCP ì„œë²„ì— SSHë¡œ ì ‘ì†í•´ì„œ ë°°í¬
# GCP ì„œë²„ì— SSHë¡œ ì ‘ì†í•´ì„œ ë°°í¬
      - name: SSH to GCP instance and deploy
        run: |
          echo "ğŸ”§ Setting GCP project..."
          gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

          echo "ğŸš€ Connecting to GCP instance and starting deployment..."
          gcloud compute ssh ${{ secrets.GCP_INSTANCE_NAME }} --zone ${{ secrets.GCP_ZONE }} --command "
            echo 'ğŸ“ ì´ë™: /home/oculo0204/apps/geotdam-server' && \
            cd /home/oculo0204/apps/geotdam-server && \

            echo 'ğŸ”„ Git pull ì‹œì‘' && \
            sudo chmod -R 777 .git && \
            git pull origin main || echo 'âš ï¸ Git pull ì‹¤íŒ¨ ë˜ëŠ” ì•ˆì „ ë””ë ‰í† ë¦¬ ì´ìŠˆ' && \

            echo 'âœ… Git ì•ˆì „ ë””ë ‰í† ë¦¬ ì„¤ì •' && \
            git config --global --add safe.directory /home/oculo0204/apps/geotdam-server && \

            echo 'ğŸ“¦ npm install ì‹œì‘' && \
            sudo npm install --unsafe-perm && \

            echo 'ğŸ“‚ DB ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰' && \
            if [ -f /home/oculo0204/apps/geotdam-server/config/config.js ]; then \
              npx sequelize-cli db:migrate --config /home/oculo0204/apps/geotdam-server/config/config.js || echo 'âš ï¸ Migrate failed or not needed, proceeding...'; \
            else \
              echo 'âš ï¸ config.js íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ê±´ë„ˆëœë‹ˆë‹¤.'; \
            fi && \
            echo 'ğŸ”“ ë¡œê·¸ íŒŒì¼ ê¶Œí•œ ì„¤ì •' && \
            sudo touch /home/oculo0204/apps/geotdam-server/app.log && \
            sudo chmod 777 /home/oculo0204/apps/geotdam-server/app.log && \

            echo 'ğŸš€ ì•± ì‹œì‘ ì¤‘...' && \
            sudo nohup npm start > /home/oculo0204/apps/geotdam-server/app.log 2>&1 & disown

            sleep 3 && \
            echo 'ğŸ“„ ìµœê·¼ ë¡œê·¸:' && \
            tail -n 10 /home/oculo0204/apps/geotdam-server/app.log || echo 'ğŸš¨ ë¡œê·¸ í™•ì¸ ì‹¤íŒ¨'

            echo 'âœ… ì•± ì‹¤í–‰ ëª…ë ¹ ì „ë‹¬ ì™„ë£Œ'
            "




