name: CI/CD Workflow

on:
  push:
    branches:
      - main

jobs:
  # ìž‘ì—…1: í…ŒìŠ¤íŠ¸ ì½”ë“œ ê²€ì‚¬
  test:
    runs-on: ubuntu-latest
    env:
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      PORT: ${{ secrets.PORT }}
      NODE_ENV: ${{ secrets.NODE_ENV }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.7

      - name: Setup Node.js environment
        uses: actions/setup-node@v4.0.3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Run tests
        run: npm test

  # ìž‘ì—…2: GCP ë°°í¬
  deploy:
    needs: test
    runs-on: ubuntu-latest
    env:
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      PORT: ${{ secrets.PORT }}
      NODE_ENV: ${{ secrets.NODE_ENV }}
    steps:
      # GCP ì¸ì¦
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v0.6.0
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

    # GCP ì„œë²„ì— SSHë¡œ ì ‘ì†í•´ì„œ ë°°í¬
      - name: SSH to GCP instance and deploy
        run: |
          echo "ðŸ”§ Setting GCP project..."
          gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

          echo "ðŸš€ Connecting to GCP instance and starting deployment..."
          gcloud compute ssh ${{ secrets.GCP_INSTANCE_NAME }} --zone ${{ secrets.GCP_ZONE }} --command "
            echo 'ðŸ“ ì´ë™: /home/oculo0204/apps/geotdam-server' && \
            cd /home/oculo0204/apps/geotdam-server && \

            echo 'ðŸ”„ Git pull ì‹œìž‘' && \
            git pull origin main && \

            echo 'âœ… Git ì•ˆì „ ë””ë ‰í† ë¦¬ ì„¤ì •' && \
            git config --global --add safe.directory /home/oculo0204/apps/geotdam-server && \

            echo 'ðŸ“¦ npm install ì‹œìž‘' && \
            npm install && \

            echo 'ðŸ“‚ DB ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰' && \
            npx sequelize-cli db:migrate || echo 'âš ï¸ Migrate failed or not needed, proceeding...' && \

            echo 'ðŸ”“ ë¡œê·¸ íŒŒì¼ ê¶Œí•œ ì„¤ì •' && \
            sudo chmod 777 /home/oculo0204/apps/geotdam-server/app.log && \

            echo 'ðŸš€ ì•± ì‹œìž‘ ì¤‘...' && \
            nohup npm start > /home/oculo0204/apps/geotdam-server/app.log 2>&1 & && \

            echo 'âœ… ì•± ì‹¤í–‰ ì™„ë£Œ'
          "



